<!doctype html><html lang=zh-cn><head><title>在 Windows 10 虚拟机中切换 i3 工作区 | Archer</title><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=description content="我使用i3wm+windows10虚拟机的方式工作时，想使用win+num切换i3的workspace. 经过一番波折之后在emacs chin"><meta name=generator content="Hugo 0.99.1"><meta name=ROBOTS content="NOINDEX, NOFOLLOW"><link rel=stylesheet href=/css/style.css><link rel="shortcut icon" href=/images/favicon.ico type=image/x-icon><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/katex.min.css integrity=sha384-RZU/ijkSsFbcmivfdRBQDtwuwVqK7GMOw6IMvKyeWL2K5UAlyp6WonmB8m7Jd0Hn crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/katex.min.js integrity=sha384-pK1WpvzWVBQiP0/GjnvRxV4mOb0oxFuyRxJlk6vVw146n3egcN5C925NCP7a7BY8 crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/contrib/auto-render.min.js integrity=sha384-vZTG03m+2yp6N6BNi5iM4rW4oIwk5DfcNdFfxkk9ZWpDriOkXX8voJBFrAO7MpVl crossorigin=anonymous onload=renderMathInElement(document.body)></script></head><body><nav class=navigation><a href=/><span class=arrow>←</span>首页</a>
<a href=/posts>归档</a>
<a href=/tags>标签</a>
<a href=/about>关于</a>
<a class=button href=https://archer-n.github.io/index.xml>订阅</a></nav><main class=main><section id=single><h1 class=title>在 Windows 10 虚拟机中切换 i3 工作区</h1><div class=tip><time datetime="2021-10-16 12:58:46 +0800 +0800">2021年10月16日</time>
<span class=split>·</span>
<span>1185字</span>
<span class=split>·</span>
<span>3分钟</span></div><aside class=toc><details><summary>Table of Contents</summary><div><nav id=TableOfContents><ul><li><a href=#headline-1>虚拟机与宿主机通信</a><ul><li><a href=#headline-2>获取NAT虚拟网关地址(获取host固定ip)</a><ul><li><a href=#headline-3>获取NAT网络名称</a></li><li><a href=#headline-4>获取虚拟网关地址</a></li></ul></li><li><a href=#headline-5>host实现http服务监听guest</a><ul><li><a href=#headline-6>eggjs 实现 simple http server</a></li><li><a href=#headline-7>systemd 开机自启动</a></li></ul></li><li><a href=#headline-8>guest监听按键发送给host</a><ul><li><a href=#headline-9>AutoHotkey</a></li><li><a href=#headline-10>AutoHotkey 开机自启动</a></li></ul></li><li><a href=#headline-11>其他</a></li></ul></li></ul></nav></div></details></aside><div class=content><p>我使用i3wm+windows10虚拟机的方式工作时，想使用win+num切换i3的workspace.
经过一番波折之后在<a href=https://emacs-china.org/t/qemu-kvm-virtual-machine-manger-windows10-i3wm-win-num-workspace/18331>emacs china</a>社区提问得到了解决思路，这里记录下解决方案。</p><p>解决方案：guest与host通信，把 guest 中的 <code class=verbatim>super+&lt;NUM></code> 翻译成 <code class=verbatim>i3-msg workspace &lt;NUM></code> 并传出来，
配合开机自启动目前用的没啥大问题。</p><div id=outline-container-headline-1 class=outline-3><h3 id=headline-1>虚拟机与宿主机通信</h3><div id=outline-text-headline-1 class=outline-text-3><div id=outline-container-headline-2 class=outline-4><h4 id=headline-2>获取NAT虚拟网关地址(获取host固定ip)</h4><div id=outline-text-headline-2 class=outline-text-4><p>我使用的 virtual machine manager 创建 windows10虚拟机使用默认的NAT网络, 在guest中访问NAT
虚拟网关地址可以访问到host。</p><div id=outline-container-headline-3 class=outline-5><h5 id=headline-3>获取NAT网络名称</h5><div id=outline-text-headline-3 class=outline-text-5><div class="src src-shell"><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  sudo virsh net-list
</span></span><span style=display:flex><span>  <span style=color:#666>[</span>sudo<span style=color:#666>]</span> password <span style=color:#a2f;font-weight:700>for</span> archer: ***
</span></span><span style=display:flex><span>   Name      State    Autostart   Persistent
</span></span><span style=display:flex><span>  --------------------------------------------
</span></span><span style=display:flex><span>   default   active   yes         yes</span></span></code></pre></div></div><p>我这里是 default</p></div></div><div id=outline-container-headline-4 class=outline-5><h5 id=headline-4>获取虚拟网关地址</h5><div id=outline-text-headline-4 class=outline-text-5><div class="src src-shell"><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  <span style=color:#080;font-style:italic># 获取XML中的网络信息</span>
</span></span><span style=display:flex><span>  sudo virsh net-dumpxml default  <span style=color:#080;font-style:italic># default 是上面获取的网络名称</span>
</span></span><span style=display:flex><span>  <span style=color:#666>[</span>sudo<span style=color:#666>]</span> password <span style=color:#a2f;font-weight:700>for</span> archer: ***
</span></span><span style=display:flex><span>  &lt;network <span style=color:#b8860b>connections</span><span style=color:#666>=</span><span style=color:#b44>&#39;1&#39;</span>&gt;
</span></span><span style=display:flex><span>    &lt;name&gt;default&lt;/name&gt;
</span></span><span style=display:flex><span>    &lt;uuid&gt;5d92e99f-a28e-49e6-a12a-0541a5988435&lt;/uuid&gt;
</span></span><span style=display:flex><span>    &lt;forward <span style=color:#b8860b>mode</span><span style=color:#666>=</span><span style=color:#b44>&#39;nat&#39;</span>&gt;
</span></span><span style=display:flex><span>      &lt;nat&gt;
</span></span><span style=display:flex><span>        &lt;port <span style=color:#b8860b>start</span><span style=color:#666>=</span><span style=color:#b44>&#39;1024&#39;</span> <span style=color:#b8860b>end</span><span style=color:#666>=</span><span style=color:#b44>&#39;65535&#39;</span>/&gt;
</span></span><span style=display:flex><span>      &lt;/nat&gt;
</span></span><span style=display:flex><span>    &lt;/forward&gt;
</span></span><span style=display:flex><span>    &lt;bridge <span style=color:#b8860b>name</span><span style=color:#666>=</span><span style=color:#b44>&#39;virbr0&#39;</span> <span style=color:#b8860b>stp</span><span style=color:#666>=</span><span style=color:#b44>&#39;on&#39;</span> <span style=color:#b8860b>delay</span><span style=color:#666>=</span><span style=color:#b44>&#39;0&#39;</span>/&gt;
</span></span><span style=display:flex><span>    &lt;mac <span style=color:#b8860b>address</span><span style=color:#666>=</span><span style=color:#b44>&#39;52:54:00:11:59:e0&#39;</span>/&gt;
</span></span><span style=display:flex><span>    &lt;ip <span style=color:#b8860b>address</span><span style=color:#666>=</span><span style=color:#b44>&#39;192.168.122.1&#39;</span> <span style=color:#b8860b>netmask</span><span style=color:#666>=</span><span style=color:#b44>&#39;255.255.255.0&#39;</span>&gt;
</span></span><span style=display:flex><span>      &lt;dhcp&gt;
</span></span><span style=display:flex><span>        &lt;range <span style=color:#b8860b>start</span><span style=color:#666>=</span><span style=color:#b44>&#39;192.168.122.2&#39;</span> <span style=color:#b8860b>end</span><span style=color:#666>=</span><span style=color:#b44>&#39;192.168.122.254&#39;</span>/&gt;
</span></span><span style=display:flex><span>      &lt;/dhcp&gt;
</span></span><span style=display:flex><span>    &lt;/ip&gt;
</span></span><span style=display:flex><span>  &lt;/network&gt;</span></span></code></pre></div></div><p>获取到 nat虚拟网关地址 ： 192.168.122.1， guest可以通过这个ip访问到host不过必须是联网的情况下。</p></div></div></div></div><div id=outline-container-headline-5 class=outline-4><h4 id=headline-5>host实现http服务监听guest</h4><div id=outline-text-headline-5 class=outline-text-4><p>我这里使用了eggjs实现了一个简单的http服务，并使用systemd/user配置为开机自启动。</p><div id=outline-container-headline-6 class=outline-5><h5 id=headline-6>eggjs 实现 <a href=https://github.com/archer-n/vm_message>simple http server</a></h5><div id=outline-text-headline-6 class=outline-text-5><ul><li><p>app/router.js</p><div class="src src-javascript"><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span>  <span style=color:#080;font-style:italic>// app/router.js 
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>  
</span></span><span style=display:flex><span>  <span style=color:#b44>&#39;use strict&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#080;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic>   ,* @param {Egg.Application} app - egg application
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic>   ,*/</span>
</span></span><span style=display:flex><span>  module.exports <span style=color:#666>=</span> app =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#a2f;font-weight:700>const</span> { router, controller } <span style=color:#666>=</span> app;
</span></span><span style=display:flex><span>    <span style=color:#080;font-style:italic>// i3 
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>    router.post(<span style=color:#b44>&#39;/i3/workspace/:id&#39;</span>, controller.i3.workspace);  <span style=color:#080;font-style:italic>// workspace
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>  };</span></span></code></pre></div></div></li><li><p>app/controller/i3.js</p><div class="src src-javascript"><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span>  <span style=color:#080;font-style:italic>// app/controller/i3.js
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>  <span style=color:#b44>&#39;use strict&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a2f;font-weight:700>const</span> Controller <span style=color:#666>=</span> require(<span style=color:#b44>&#39;egg&#39;</span>).Controller;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#080;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic>   ,* @swagger
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic>   ,* tags:
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic>   ,*   name: I3Controller
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic>   ,*   description: 处理虚拟机发送i3的相关指令
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic>   ,*/</span>
</span></span><span style=display:flex><span>  <span style=color:#a2f;font-weight:700>class</span> I3MsgController <span style=color:#a2f;font-weight:700>extends</span> Controller {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    get I3Service() {
</span></span><span style=display:flex><span>      <span style=color:#a2f;font-weight:700>return</span> <span style=color:#a2f;font-weight:700>this</span>.ctx.service.i3;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#080;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic>     ,* @swagger
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic>     ,* /i3/workspace/{id}:
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic>     ,*   post:
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic>     ,*     summary: i3-msg workspace $id
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic>     ,*     tags:
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic>     ,*       - I3Controller
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic>     ,*     parameters:
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic>     ,*       - in: path
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic>     ,*         name: id
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic>     ,*         type: string
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic>     ,*         description: workspace id
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic>     ,*         required: true
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic>     ,*     response:
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic>     ,*       200:
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic>     ,*         description: ok
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic>     ,*/</span>
</span></span><span style=display:flex><span>    <span style=color:#a2f;font-weight:700>async</span> workspace() {
</span></span><span style=display:flex><span>      <span style=color:#a2f;font-weight:700>const</span> id <span style=color:#666>=</span> <span style=color:#a2f;font-weight:700>this</span>.ctx.params.id; <span style=color:#080;font-style:italic>// 获取虚拟机id
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>      <span style=color:#a2f;font-weight:700>this</span>.ctx.body <span style=color:#666>=</span> <span style=color:#a2f;font-weight:700>await</span> <span style=color:#a2f;font-weight:700>this</span>.I3Service.workspace(id);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  module.exports <span style=color:#666>=</span> I3MsgController;</span></span></code></pre></div></div></li><li><p>app/service/i3.js</p><div class="src src-javascript"><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span>  <span style=color:#080;font-style:italic>// app/service/i3.js
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>  <span style=color:#b44>&#39;use strict&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a2f;font-weight:700>const</span> Service <span style=color:#666>=</span> require(<span style=color:#b44>&#39;egg&#39;</span>).Service;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a2f;font-weight:700>const</span> util <span style=color:#666>=</span> require(<span style=color:#b44>&#39;util&#39;</span>);
</span></span><span style=display:flex><span>  <span style=color:#a2f;font-weight:700>const</span> child_process <span style=color:#666>=</span> require(<span style=color:#b44>&#39;child_process&#39;</span>);
</span></span><span style=display:flex><span>  <span style=color:#a2f;font-weight:700>const</span> exec <span style=color:#666>=</span> util.promisify(child_process.exec);
</span></span><span style=display:flex><span>  <span style=color:#a2f;font-weight:700>const</span> fs <span style=color:#666>=</span> require(<span style=color:#b44>&#39;fs&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a2f;font-weight:700>const</span> I3SOCK <span style=color:#666>=</span> Symbol.<span style=color:#a2f;font-weight:700>for</span>(<span style=color:#b44>&#39;I3Service#I3SOCK&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a2f;font-weight:700>class</span> I3Service <span style=color:#a2f;font-weight:700>extends</span> Service {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#080;font-style:italic>// systemd 开机自启动拿不到I3SOCK变量，这里自己去拿一次
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>    get I3SOCK() {
</span></span><span style=display:flex><span>      <span style=color:#a2f;font-weight:700>if</span> (<span style=color:#666>!</span><span style=color:#a2f;font-weight:700>this</span>.app[I3SOCK]) {
</span></span><span style=display:flex><span>        <span style=color:#a2f;font-weight:700>try</span> {
</span></span><span style=display:flex><span>          <span style=color:#080;font-style:italic>// directory path
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>          <span style=color:#a2f;font-weight:700>const</span> dir <span style=color:#666>=</span> <span style=color:#b44>&#39;/run/user/1000/i3/&#39;</span>;
</span></span><span style=display:flex><span>          <span style=color:#a2f;font-weight:700>const</span> files <span style=color:#666>=</span> fs.readdirSync(dir);
</span></span><span style=display:flex><span>          <span style=color:#a2f;font-weight:700>this</span>.ctx.logger.info(<span style=color:#b44>&#39;files: %j&#39;</span>, files);
</span></span><span style=display:flex><span>          <span style=color:#080;font-style:italic>// files object contains all files names
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>          <span style=color:#080;font-style:italic>// log them on console
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>          <span style=color:#a2f;font-weight:700>for</span> (<span style=color:#a2f;font-weight:700>const</span> file <span style=color:#a2f;font-weight:700>of</span> files) {
</span></span><span style=display:flex><span>            <span style=color:#a2f;font-weight:700>if</span> (file.startsWith(<span style=color:#b44>&#39;ipc-socket&#39;</span>)) {
</span></span><span style=display:flex><span>              <span style=color:#a2f;font-weight:700>this</span>.app[I3SOCK] <span style=color:#666>=</span> dir <span style=color:#666>+</span> file;
</span></span><span style=display:flex><span>              <span style=color:#a2f;font-weight:700>break</span>;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>        } <span style=color:#a2f;font-weight:700>catch</span> (err) {
</span></span><span style=display:flex><span>          <span style=color:#a2f;font-weight:700>this</span>.ctx.logger.error(err);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>      <span style=color:#a2f;font-weight:700>return</span> <span style=color:#a2f;font-weight:700>this</span>.app[I3SOCK];
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#080;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic>     ,* i3-msg - send messages to i3 window manager
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic>     ,* @param {string} message Send ipc message, see `man i3-msg`
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic>     ,* @returns Promise&lt;any&gt; result
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic>     ,*/</span>
</span></span><span style=display:flex><span>    <span style=color:#a2f;font-weight:700>async</span> i3msg(message) {
</span></span><span style=display:flex><span>      <span style=color:#a2f;font-weight:700>const</span> command <span style=color:#666>=</span> <span style=color:#b44>`i3-msg -s </span><span style=color:#b68;font-weight:700>${</span><span style=color:#a2f;font-weight:700>this</span>.I3SOCK<span style=color:#b68;font-weight:700>}</span><span style=color:#b44> </span><span style=color:#b68;font-weight:700>${</span>message<span style=color:#b68;font-weight:700>}</span><span style=color:#b44>`</span>;
</span></span><span style=display:flex><span>      <span style=color:#a2f;font-weight:700>this</span>.ctx.logger.info(<span style=color:#b44>&#39;command: %s&#39;</span>, command);
</span></span><span style=display:flex><span>      <span style=color:#a2f;font-weight:700>return</span> <span style=color:#a2f;font-weight:700>await</span> exec(command);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#080;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic>     ,* i3-msg workspace $id
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic>     ,* @param {string} id id
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic>     ,* returns {void}
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic>     ,*/</span>
</span></span><span style=display:flex><span>    <span style=color:#a2f;font-weight:700>async</span> workspace(id) {
</span></span><span style=display:flex><span>      <span style=color:#a2f;font-weight:700>await</span> <span style=color:#a2f;font-weight:700>this</span>.i3msg(<span style=color:#b44>`workspace </span><span style=color:#b68;font-weight:700>${</span>id<span style=color:#b68;font-weight:700>}</span><span style=color:#b44>`</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  module.exports <span style=color:#666>=</span> I3Service;</span></span></code></pre></div></div></li></ul></div></div><div id=outline-container-headline-7 class=outline-5><h5 id=headline-7>systemd 开机自启动</h5><div id=outline-text-headline-7 class=outline-text-5><p>~/.config/systemd/user/archer-node-server.service</p><div class="src src-text"><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>  [Unit]
</span></span><span style=display:flex><span>  Description=Archer&#39;s Node Server
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  [Service]
</span></span><span style=display:flex><span>  Type=forking
</span></span><span style=display:flex><span>  ExecStart=/home/archer/workspace/nodejs/vm_message/start.sh # 替换成服务启动脚本
</span></span><span style=display:flex><span>  ExecStop=/home/archer/workspace/nodejs/vm_message/stop.sh   # 替换成服务停止脚本
</span></span><span style=display:flex><span>  WorkingDirectory=/home/archer/workspace/nodejs/vm_message   # 服务目录
</span></span><span style=display:flex><span>  Environment=PATH=/home/archer/.nvm/versions/node/v12.22.3/bin:/usr/bin:/usr/local/bin # 添加node到环境变量
</span></span><span style=display:flex><span>  Restart=on-failure
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  [Install]
</span></span><span style=display:flex><span>  WantedBy=default.target</span></span></code></pre></div></div><p>启动systemd服务</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  systemctl --user start archer-node-server
</span></span><span style=display:flex><span>  systemctl --user enalbe archer-node-server</span></span></code></pre></div></div><p>注意： systemd 开机自启动很多环境变量拿不到，如I3SOCK,导致自启动发送i3-msg失败，<a href=https://github.com/archer-n/vm_message/blob/7c2688fbd422f920c786e11aeaad865fb541435b/app/service/i3.js#L16>我这里自己获取了一次I3SOCK</a>。</p></div></div></div></div><div id=outline-container-headline-8 class=outline-4><h4 id=headline-8>guest监听按键发送给host</h4><div id=outline-text-headline-8 class=outline-text-4><div id=outline-container-headline-9 class=outline-5><h5 id=headline-9><a href=https://www.autohotkey.com/>AutoHotkey</a></h5><div id=outline-text-headline-9 class=outline-text-5><p>使用autohotkey监听windows10虚拟机的按键,并发送给host.</p><p>i3-msg workspace.ahk</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  <span style=color:#080;font-style:italic>#NoEnv  ; Recommended for performance and compatibility with future AutoHotkey releases.</span>
</span></span><span style=display:flex><span>  ; <span style=color:#080;font-style:italic>#Warn  ; Enable warnings to assist with detecting common errors.</span>
</span></span><span style=display:flex><span>  SendMode Input  ; Recommended <span style=color:#a2f;font-weight:700>for</span> new scripts due to its superior speed and reliability.
</span></span><span style=display:flex><span>  SetWorkingDir %A_ScriptDir%  ; Ensures a consistent starting directory.
</span></span><span style=display:flex><span>  <span style=color:#080;font-style:italic># host 替换成NAT虚拟网关地址，端口换成你自己定义的http服务的端口号</span>
</span></span><span style=display:flex><span>  SwitchI3Workspace<span style=color:#666>(</span>wid<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>      host :<span style=color:#666>=</span> <span style=color:#b44>&#34;http://192.168.122.1:13999&#34;</span>
</span></span><span style=display:flex><span>      req :<span style=color:#666>=</span> host
</span></span><span style=display:flex><span>      . <span style=color:#b44>&#34;/i3/workspace&#34;</span>
</span></span><span style=display:flex><span>      . <span style=color:#b44>&#34;/&#34;</span>
</span></span><span style=display:flex><span>      . wid
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      whr :<span style=color:#666>=</span> ComObjCreate<span style=color:#666>(</span><span style=color:#b44>&#34;WinHttp.WinHttpRequest.5.1&#34;</span><span style=color:#666>)</span>
</span></span><span style=display:flex><span>      whr.Open<span style=color:#666>(</span><span style=color:#b44>&#34;POST&#34;</span>, req<span style=color:#666>)</span>
</span></span><span style=display:flex><span>      whr.Send<span style=color:#666>()</span>
</span></span><span style=display:flex><span>      <span style=color:#a2f;font-weight:700>return</span>
</span></span><span style=display:flex><span>  <span style=color:#666>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#080;font-style:italic>#1::SwitchI3Workspace(&#34;1&#34;)</span>
</span></span><span style=display:flex><span>  <span style=color:#080;font-style:italic>#2::SwitchI3Workspace(&#34;2&#34;)</span>
</span></span><span style=display:flex><span>  <span style=color:#080;font-style:italic>#3::SwitchI3Workspace(&#34;3&#34;)</span>
</span></span><span style=display:flex><span>  <span style=color:#080;font-style:italic>#4::SwitchI3Workspace(&#34;4&#34;)</span>
</span></span><span style=display:flex><span>  <span style=color:#080;font-style:italic>#5::SwitchI3Workspace(&#34;5&#34;)</span>
</span></span><span style=display:flex><span>  <span style=color:#080;font-style:italic>#6::SwitchI3Workspace(&#34;6&#34;)</span>
</span></span><span style=display:flex><span>  <span style=color:#080;font-style:italic>#7::SwitchI3Workspace(&#34;7&#34;)</span>
</span></span><span style=display:flex><span>  <span style=color:#080;font-style:italic>#8::SwitchI3Workspace(&#34;8&#34;)</span>
</span></span><span style=display:flex><span>  <span style=color:#080;font-style:italic>#9::SwitchI3Workspace(&#34;9&#34;)</span>
</span></span><span style=display:flex><span>  <span style=color:#080;font-style:italic>#0::SwitchI3Workspace(&#34;10&#34;)</span></span></span></code></pre></div></div></div></div><div id=outline-container-headline-10 class=outline-5><h5 id=headline-10><a href=https://wyagd001.github.io/zh-cn/docs/FAQ.htm#Startup>AutoHotkey 开机自启动</a></h5></div></div></div><div id=outline-container-headline-11 class=outline-4><h4 id=headline-11>其他</h4><div id=outline-text-headline-11 class=outline-text-4><ul><li>autohotkey有时会抽风.. ，一般停止脚本可以解决，不行就重启 - -。</li><li>systemd开机自启动注意下nodejs, I3SOCK 等环境变量问题。</li></ul></div></div></div></div></div><div class=tags><a href=https://archer-n.github.io/tags/i3wm>i3wm</a>
<a href=https://archer-n.github.io/tags/kvm>kvm</a>
<a href=https://archer-n.github.io/tags/qemu>qemu</a>
<a href=https://archer-n.github.io/tags/nat>nat</a></div></section></main><footer id=footer><div id=social><a class=symbol href=https://github.com/archer-n rel=me target=_blank><svg fill="#bbb" width="28" height="28" viewBox="0 0 72 72" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><title>Github</title><desc>Created with Sketch.</desc><defs/><g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="Social-Icons---Rounded-Black" transform="translate(-264.000000, -939.000000)"><g id="Github" transform="translate(264.000000, 939.000000)"><path d="M8 72H64c4.418278.0 8-3.581722 8-8V8c0-4.418278-3.581722-8-8-8H8c-4.418278 811624501e-24-8 3.581722-8 8V64c541083001e-24 4.418278 3.581722 8 8 8z" id="Rounded" fill="#bbb"/><path d="M35.9985 13C22.746 13 12 23.7870921 12 37.096644c0 10.6440272 6.876 19.6751861 16.4145 22.8617681C29.6145 60.1797862 30.0525 59.4358488 30.0525 58.7973276 30.0525 58.2250681 30.0315 56.7100863 30.0195 54.6996482c-6.6765 1.4562499-8.085-3.2302544-8.085-3.2302544-1.0905-2.7829884-2.664-3.5239139-2.664-3.5239139C17.091 46.4500754 19.4355 46.4801943 19.4355 46.4801943c2.4075.1701719 3.675 2.4833051 3.675 2.4833051 2.142 3.6820383 5.6175 2.6188404 6.9855 2.0014024C30.3135 49.4077535 30.9345 48.3460615 31.62 47.7436831 26.2905 47.1352808 20.688 45.0691228 20.688 35.8361671c0-2.6308879.9345-4.781379 2.4705-6.4665327C22.911 28.7597262 22.0875 26.3110578 23.3925 22.9934585c0 0 2.016-.6475568 6.6 2.4697516C31.908 24.9285993 33.96 24.6620468 36.0015 24.6515052 38.04 24.6620468 40.0935 24.9285993 42.0105 25.4632101c4.581-3.1173084 6.5925-2.4697516 6.5925-2.4697516C49.9125 26.3110578 49.089 28.7597262 48.8415 29.3696344 50.3805 31.0547881 51.309 33.2052792 51.309 35.8361671c0 9.2555448-5.6115 11.29309-10.9575 11.8894446.860999999999997.7439374 1.629 2.2137408 1.629 4.4621184C41.9805 55.4089489 41.9505 58.0067059 41.9505 58.7973276 41.9505 59.4418726 42.3825 60.1918338 43.6005 59.9554002 53.13 56.7627944 60 47.7376593 60 37.096644 60 23.7870921 49.254 13 35.9985 13" fill="#fff"/></g></g></g></svg></a></div><div class=copyright>© Copyright
2022
<span class=split><svg fill="#bbb" width="15" height="15" id="heart-15" xmlns="http://www.w3.org/2000/svg" width="15" height="15" viewBox="0 0 15 15"><path d="M13.91 6.75c-1.17 2.25-4.3 5.31-6.07 6.94-.1903.1718-.4797.1718-.67.0C5.39 12.06 2.26 9 1.09 6.75-1.48 1.8 5-1.5 7.5 3.45 10-1.5 16.48 1.8 13.91 6.75z"/></svg></span>Archer</div></footer></body></html>